<!DOCTYPE html>
<html>
<head>
    <title>TDCReleaseBurnUp</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"pulldown-container",layout:{type:"hbox",align:"stretch"}},{xtype:"container",itemId:"release-container",layout:{type:"vbox",align:"stretch"}},{xtype:"container",itemId:"prd-stories-container",layout:{type:"vbox",align:"stretch"}},{xtype:"container",itemId:"nfr-stories-container",layout:{type:"vbox",align:"stretch"}}],releaseStore:void 0,prdUserStoryStore:void 0,nfrUserStoryStore:void 0,launch:function(){this._loadReleases()},_loadReleases:function(){var me=this,releaseComboBox=Ext.create("Rally.ui.combobox.ReleaseComboBox",{itemId:"release-combobox",fieldLabel:"Release",labelAlign:"right",width:300,listeners:{ready:me._loadData,select:me._loadData,scope:me}});me.down("#pulldown-container").add(releaseComboBox);var testPlanCheckbox=Ext.create("Rally.ui.CheckboxField",{xtype:"rallycheckboxfield",itemId:"testplan-checkbox",fieldLabel:"Include Test Plan",value:!1,listeners:{change:me._loadData,scope:me}});me.down("#pulldown-container").add(testPlanCheckbox)},_loadData:function(){var me=this,selectedRelease=me.down("#release-combobox").getRecord(),selectedReleaseRef=selectedRelease.get("_ref"),selectedReleaseName=selectedRelease.get("Name");me.down("#release-container").removeAll(),me.down("#prd-stories-container").removeAll(),me.down("#nfr-stories-container").removeAll(),me._loadReleaseData(),me._loadUserStoryData()},_loadReleaseData:function(){var me=this,selectedReleaseName=me.down("#release-combobox").getRecord().get("Name"),myFilters=me._getReleaseFilters(selectedReleaseName);me.releaseStore?(me.releaseStore.setFilter(myFilters),me.releaseStore.load()):me.releaseStore=Ext.create("Rally.data.wsapi.Store",{model:"Release",autoLoad:!0,filters:myFilters,listeners:{load:function(myStore,myData,success){me._createReleaseTable(myStore,myData)},scope:me},fetch:["Name","StartDate","EndDate","PlannedVelocity","State","Theme","Version","ReleaseDate","ReleaseStartDate","Version"]})},_getReleaseFilters:function(releaseValue){var releaseFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Name",operation:"=",value:releaseValue});return releaseFilter},_getUserStoryFilters:function(releaseName){var containsPRDTagFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Tags.Name",operator:"contains",value:"PRD"}),containsNFRTagFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Tags.Name",operator:"contains",value:"NFR"}),hasParentFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Parent",operator:"!=",value:null}),hasChildrenFilter=Ext.create("Rally.data.wsapi.Filter",{property:"DirectChildrenCount",operator:">",value:0}),inReleaseFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",operation:"=",value:releaseName}),nullReleaseFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",operation:"=",value:null}),userStoryFilter1=containsNFRTagFilter.or(containsPRDTagFilter),userStoryFilter2=inReleaseFilter.and(hasParentFilter),userStoryFilter3=hasParentFilter.and(hasChildrenFilter),userStoryFilter=userStoryFilter1.or(userStoryFilter2);return userStoryFilter=userStoryFilter.or(userStoryFilter3)},_createReleaseTable:function(myReleaseStore,myReleaseData){var me=this,selectedRelease=me.down("#release-combobox").getRecord(),releaseName=selectedRelease.get("Name"),releaseRef=selectedRelease.get("_ref");releaseName=myReleaseData[0].get("Name"),releaseTheme=myReleaseData[0].get("Theme"),releaseName="<p><strong>"+releaseName+"</strong></p>",releaseVersion=myReleaseData[0].get("Version");var releaseStart=new Date(myReleaseData[0].get("ReleaseStartDate"));releaseEnd=new Date(myReleaseData[0].get("ReleaseDate")),releaseState=myReleaseData[0].get("State"),this.releaseTable=Ext.create("Ext.panel.Panel",{title:"Release Overview",layout:{type:"table",columns:2},defaults:{bodyStyle:"padding:20px"},items:[{html:releaseName,colspan:2},{html:"Version: "+releaseVersion},{html:"Release State: "+releaseState},{html:"Release Start Date: "+Ext.Date.format(releaseStart,"F j, Y")},{html:"Release Date: "+Ext.Date.format(releaseEnd,"F j, Y")},{html:releaseTheme,colspan:2}]}),this.down("#release-container").add(this.releaseTable)},_loadUserStoryData:function(){var me=this,selectedRelease=me.down("#release-combobox").getRecord(),selectedReleaseName=selectedRelease.get("Name"),selectedReleaseRef=selectedRelease.get("_ref");if(me.userStoryStore)me.userStoryStore.setFilter(me._getUserStoryFilters(selectedReleaseName)),me.userStoryStore.load();else{var currentProject=this.getContext().getProject();me.userStoryStore=Ext.create("Rally.data.wsapi.Store",{model:"User Story",limit:1/0,pageSize:200,autoLoad:!0,context:{project:this.getContext().getProjectRef(),projectScopeUp:!0,projectScopeDown:!0},filters:me._getUserStoryFilters(selectedReleaseName),sorters:[{property:"FormattedID",direction:"DESC"}],listeners:{load:function(myStore,myData,success){var PRDRequirements=[],NFRRequirements=[],count=myStore.count();0===count?console.log("Warning: No user stories found!"):(console.log("Found ",count," user stories"),PRDRequirements=me._inspectUserStories(myStore,"PRD"),me._renderRequirementsGrid(PRDRequirements,"PRD"),NFRRequirements=me._inspectUserStories(myStore,"NFR"),me._renderRequirementsGrid(NFRRequirements,"NFR"))},scope:me},fetch:["FormattedID","Name","Description","c_MoSCow","Release","Children","Parent","Tags","c_TestPlan","HasParent"]})}},_getPRDUserStories:function(myUserStoryStore,requirementType){var y=0,numStories=myUserStoryStore.count(),requirementTypeUserStories=[];do{var myUserStory=myUserStoryStore.getAt(y),myTags=myUserStory.get("Tags");if(myTags.Count>0){var tagsNameArray=myTags._tagsNameArray,prdUserStory=!1;for(var tag in tagsNameArray)tagsNameArray[tag].Name==requirementType&&(prdUserStory=!0);prdUserStory===!0&&requirementTypeUserStories.push(myUserStory)}y++}while(numStories>y);return requirementTypeUserStories},_getReleases:function(myUserStory,myUserStoryStore){var releaseRefs=[],releaseNames=[],directChildren=myUserStory.get("DirectChildrenCount");if(0===directChildren){var storyRelease=myUserStory.get("Release");if(null!==storyRelease){var storyReleaseRef=storyRelease._ref,storyReleaseName=storyRelease.Name;releaseRefs.push(storyReleaseRef),releaseNames.push(storyReleaseName)}else releaseRefs.push(null),releaseNames.push("")}else{var userStoryFormattedID=myUserStory.get("FormattedID"),childrenUserStories=[];myUserStoryStore.each(function(myUserStory){var myParentObj=myUserStory.get("Parent");if(null!==myParentObj){var myFormattedID=myParentObj.FormattedID;myFormattedID==userStoryFormattedID&&childrenUserStories.push(myUserStory)}},this);for(var x in childrenUserStories){var childrenReleases=this._getReleases(childrenUserStories[x],myUserStoryStore);for(x in childrenReleases)releaseNames.push(childrenReleases[x])}}return releaseNames},_inspectUserStories:function(myUserStoryStore,requirementType){var me=this,PRDStories=[],selectedRelease=me.down("#release-combobox").getRecord(),selectedReleaseName=selectedRelease.get("Name");PRDStories=this._getPRDUserStories(myUserStoryStore,requirementType);var PRDRecords=[],PRDReleases=[];for(var PRDStory in PRDStories)if(PRDReleases=this._getReleases(PRDStories[PRDStory],myUserStoryStore),PRDReleases=this._arrayUnique(PRDReleases),this._arrayContains(PRDReleases,selectedReleaseName)){var note=!0;note=PRDReleases.length>1?!0:!1;var PRDRecord={UserStory:PRDStories[PRDStory],SpansReleases:note};PRDRecords.push(PRDRecord)}return PRDRecords},_renderRequirementsGrid:function(PRDRecords,requirementType){var containerName,storeId,title;"PRD"==requirementType&&(containerName="#prd-stories-container",storeId="prdUserStoryStore",title="Functional Requirements"),"NFR"==requirementType&&(containerName="#nfr-stories-container",storeId="nfrUserStoryStore",title="Non-Functional Requirements");var testPlanCheckboxValue=this.down("#testplan-checkbox").getValue(),gridFields=["FormattedID","Name","Description","MoSCoW"];if(testPlanCheckboxValue===!0&&gridFields.push("Test Plan"),0!==PRDRecords.length){userStoryStore=Ext.create("Ext.data.Store",{storeId:storeId,fields:gridFields,proxy:{type:"memory",reader:{type:"json",root:"items"}}});for(var x in PRDRecords){var userStory=PRDRecords[x].UserStory,PRDRecord={FormattedID:userStory.get("FormattedID"),Name:userStory.get("Name"),Description:userStory.get("Description"),MoSCoW:userStory.get("c_MoSCoW")};testPlanCheckboxValue===!0&&(PRDRecord["Test Plan"]=userStory.get("c_TestPlan")),userStoryStore.add(PRDRecord)}var gridColumns=[{text:"FormattedID",dataIndex:"FormattedID",width:100},{text:"Name",dataIndex:"Name",width:400,renderer:function(value){var display='<p style="white-space:normal">'+value+"</p>";return display}},{text:"Description",dataIndex:"Description",flex:1,renderer:function(value){var display='<p style="white-space:normal">'+value+"</p>";return display}},{text:"MoSCoW",dataIndex:"MoSCoW",width:100}];testPlanCheckboxValue===!0&&gridColumns.push({text:"Test Plan",dataIndex:"Test Plan",width:400,renderer:function(value){var display='<p style="white-space:normal">'+value+"</p>";return display}}),userStoryGrid=Ext.create("Ext.grid.Panel",{title:title,store:Ext.data.StoreManager.lookup(storeId),columns:gridColumns,renderTo:Ext.getBody()}),this.down(containerName).add(userStoryGrid)}else userStoryLabel=Ext.create("Ext.form.Panel",{title:title,width:400,padding:10,renderTo:Ext.getBody(),layout:{type:"hbox",align:"middle"},items:[{xtype:"label",forID:"myFieldId",text:"No user stories with "+requirementType+" tag found in selected release!",margin:"0 0 0 10"}]}),this.down(containerName).add(userStoryLabel)},_arrayUnique:function(a){return a.reduce(function(p,c){return 0>p.indexOf(c)&&p.push(c),p},[])},_arrayContains:function(a,obj){for(var i=0;a.length>i;i++)if(a[i]===obj)return!0;return!1}});

            Rally.launchApp('CustomApp', {
                name:"TDCReleaseBurnUp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
