<!DOCTYPE html>
<html>
<head>
    <title>TDCReleaseBurnUp</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"pulldown-container",layout:{type:"hbox",align:"stretch"}},{xtype:"container",itemId:"release-container",layout:{type:"vbox",align:"stretch"}},{xtype:"container",itemId:"prd-stories-container",layout:{type:"vbox",align:"stretch"}},{xtype:"container",itemId:"nfr-stories-container",layout:{type:"vbox",align:"stretch"}}],releaseStore:void 0,prdUserStoryStore:void 0,nfrUserStoryStore:void 0,launch:function(){this._loadReleases()},_loadReleases:function(){var me=this,releaseComboBox=Ext.create("Rally.ui.combobox.ReleaseComboBox",{itemId:"release-combobox",fieldLabel:"Release",labelAlign:"right",width:300,listeners:{ready:me._loadData,select:me._loadData,scope:me}});me.down("#pulldown-container").add(releaseComboBox);var testPlanCheckbox=Ext.create("Rally.ui.CheckboxField",{xtype:"rallycheckboxfield",itemId:"testplan-checkbox",fieldLabel:"Include Test Plan",value:!1,listeners:{change:me._loadData,scope:me}});me.down("#pulldown-container").add(testPlanCheckbox)},_loadData:function(){var me=this,selectedRelease=me.down("#release-combobox").getRecord(),selectedReleaseRef=selectedRelease.get("_ref"),selectedReleaseName=selectedRelease.get("Name");me._loadReleaseData(),me._loadUserStoryData()},_loadReleaseData:function(){var me=this,selectedReleaseName=me.down("#release-combobox").getRecord().get("Name"),myFilters=me._getReleaseFilters(selectedReleaseName);me.releaseStore?(me.releaseStore.setFilter(myFilters),me.releaseStore.load()):me.releaseStore=Ext.create("Rally.data.wsapi.Store",{model:"Release",autoLoad:!0,filters:myFilters,listeners:{load:function(myStore,myData,success){me._createReleaseTable(myStore,myData)},scope:me},fetch:["Name","StartDate","EndDate","PlannedVelocity","State","Theme","Version","ReleaseDate","ReleaseStartDate","Version"]})},_getReleaseFilters:function(releaseValue){var releaseFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Name",operation:"=",value:releaseValue});return releaseFilter},_getUserStoryFilters:function(){var containsPRDTagFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Tags.Name",operator:"contains",value:"PRD"}),containsNFRTagFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Tags.Name",operator:"contains",value:"NFR"}),hasChildrenFilter=Ext.create("Rally.data.wsapi.Filter",{property:"DirectChildrenCount",operator:">",value:0}),userStoryFilter=containsNFRTagFilter.or(containsPRDTagFilter);return userStoryFilter=userStoryFilter.or(hasChildrenFilter)},_createReleaseTable:function(myReleaseStore,myReleaseData){var me=this,selectedRelease=me.down("#release-combobox").getRecord(),releaseName=selectedRelease.get("Name");releaseName=myReleaseData[0].get("Name"),releaseTheme=myReleaseData[0].get("Theme"),console.log("release name: ",releaseName),console.log("release theme: ",releaseTheme),console.log("release store: ",myReleaseStore,"release data: ",myReleaseData),releaseName="<p><strong>"+releaseName+"</strong></p>",releaseVersion=myReleaseData[0].get("Version");var releaseStart=new Date(myReleaseData[0].get("ReleaseStartDate"));releaseEnd=new Date(myReleaseData[0].get("ReleaseDate")),releaseState=myReleaseData[0].get("State"),this.releaseTable=Ext.create("Ext.panel.Panel",{title:"Release Overview",layout:{type:"table",columns:2},defaults:{bodyStyle:"padding:20px"},items:[{html:releaseName,colspan:2},{html:"Version: "+releaseVersion},{html:"Release State: "+releaseState},{html:"Release Start Date: "+Ext.Date.format(releaseStart,"F j, Y")},{html:"Release Date: "+Ext.Date.format(releaseEnd,"F j, Y")},{html:releaseTheme,colspan:2}]}),this.down("#release-container").removeAll(),this.down("#release-container").add(this.releaseTable)},_loadUserStoryData:function(){var me=this,selectedRelease=me.down("#release-combobox").getRecord(),selectedReleaseName=selectedRelease.get("Name"),selectedReleaseRef=selectedRelease.get("_ref");me.userStoryStore?me.userStoryStore.load():me.userStoryStore=Ext.create("Rally.data.wsapi.Store",{model:"User Story",limit:1/0,pageSize:3e4,autoLoad:!0,filters:me._getUserStoryFilters(),sorters:[{property:"FormattedID",direction:"DESC"}],listeners:{load:function(myStore,myData,success){var count=myStore.count();0==count?console.log("Warning: No user stories found!"):(console.log("Found ",count," user stories"),PRDRequirements=me._inspectUserStories(myStore,"PRD"),me._renderRequirementsGrid(PRDRequirements,"PRD"),NFRRequirements=me._inspectUserStories(myStore,"NFR"),me._renderRequirementsGrid(NFRRequirements,"NFR"))},scope:me},fetch:["FormattedID","Name","Description","c_MoSCow","Release","Children","Parent","Tags","c_TestPlan"]})},_getPRDUserStories:function(myUserStoryStore,requirementType){var y=0,numStories=myUserStoryStore.count(),requirementTypeUserStories=[];do{if(myUserStory=myUserStoryStore.getAt(y),formattedID=myUserStory.get("FormattedID"),myTags=myUserStory.get("Tags"),myTags.Count>0){tagsNameArray=myTags._tagsNameArray;var prdUserStory=!1;for(tag in tagsNameArray)tagsNameArray[tag].Name==requirementType&&(prdUserStory=!0);1==prdUserStory&&requirementTypeUserStories.push(myUserStory)}y++}while(numStories>y);return requirementTypeUserStories},_getReleases:function(myUserStory,myUserStoryStore){var me=this,releaseRefs=[],directChildren=myUserStory.get("DirectChildrenCount");if(0==directChildren){var storyRelease=myUserStory.get("Release");if(null!=storyRelease){var storyReleaseRef=storyRelease._ref;releaseRefs.push(storyReleaseRef)}else releaseRefs.push(null)}else{var userStoryFormattedID=myUserStory.get("FormattedID"),childrenUserStories=[];myUserStoryStore.each(function(myUserStory){var myParentObj=myUserStory.get("Parent");if(null!=myParentObj){var myFormattedID=myParentObj.FormattedID;myFormattedID==userStoryFormattedID&&childrenUserStories.push(myUserStory)}},this);for(x in childrenUserStories){childrenReleases=this._getReleases(childrenUserStories[x],myUserStoryStore);for(x in childrenReleases)releaseRefs.push(childrenReleases[x])}}return releaseRefs},_inspectUserStories:function(myUserStoryStore,requirementType){var me=this,PRDStories=[],selectedRelease=me.down("#release-combobox").getRecord(),selectedReleaseName=selectedRelease.get("Name"),selectedReleaseRef=selectedRelease.get("_ref");PRDStories=this._getPRDUserStories(myUserStoryStore,requirementType);var numPRDStories=PRDStories.length,PRDRecords=[],PRDReleases=[];for(PRDStory in PRDStories)PRDReleases=this._getReleases(PRDStories[PRDStory],myUserStoryStore),PRDReleases=this._arrayUnique(PRDReleases),this._arrayContains(PRDReleases,selectedReleaseRef)&&(note=PRDReleases.length>1?!0:!1,PRDRecord={UserStory:PRDStories[PRDStory],SpansReleases:note},PRDRecords.push(PRDRecord));return PRDRecords},_renderRequirementsGrid:function(PRDRecords,requirementType){"PRD"==requirementType&&(containerName="#prd-stories-container",storeId="prdUserStoryStore",title="Functional Requirements"),"NFR"==requirementType&&(containerName="#nfr-stories-container",storeId="nfrUserStoryStore",title="Non-Functional Requirements"),this.down(containerName).removeAll();var testPlanCheckboxValue=this.down("#testplan-checkbox").getValue();if(gridFields=["FormattedID","Name","Description","MoSCoW"],1==testPlanCheckboxValue&&gridFields.push("Test Plan"),0!=PRDRecords.length){userStoryStore=Ext.create("Ext.data.Store",{storeId:storeId,fields:gridFields,proxy:{type:"memory",reader:{type:"json",root:"items"}}});for(x in PRDRecords)userStory=PRDRecords[x].UserStory,PRDRecord={FormattedID:userStory.get("FormattedID"),Name:userStory.get("Name"),Description:userStory.get("Description"),MoSCoW:userStory.get("c_MoSCoW")},1==testPlanCheckboxValue&&(PRDRecord["Test Plan"]=userStory.get("c_TestPlan")),userStoryStore.add(PRDRecord);gridColumns=[{text:"FormattedID",dataIndex:"FormattedID",width:100},{text:"Name",dataIndex:"Name",width:400},{text:"Description",dataIndex:"Description",flex:1,renderer:function(value){var display='<p style="white-space:normal">'+value+"</p>";return display}},{text:"MoSCoW",dataIndex:"MoSCoW",width:100}],1==testPlanCheckboxValue&&gridColumns.push({text:"Test Plan",dataIndex:"Test Plan",width:400,renderer:function(value){var display='<p style="white-space:normal">'+value+"</p>";return display}}),userStoryGrid=Ext.create("Ext.grid.Panel",{title:title,store:Ext.data.StoreManager.lookup(storeId),columns:gridColumns,renderTo:Ext.getBody()}),this.down(containerName).add(userStoryGrid)}else userStoryLabel=Ext.create("Ext.form.Panel",{title:title,width:400,padding:10,renderTo:Ext.getBody(),layout:{type:"hbox",align:"middle"},items:[{xtype:"label",forID:"myFieldId",text:"No user stories with "+requirementType+" tag found in selected release!",margin:"0 0 0 10"}]}),this.down(containerName).add(userStoryLabel)},_arrayUnique:function(a){return a.reduce(function(p,c){return 0>p.indexOf(c)&&p.push(c),p},[])},_arrayContains:function(a,obj){for(var i=0;a.length>i;i++)if(a[i]===obj)return!0;return!1}});

            Rally.launchApp('CustomApp', {
                name:"TDCReleaseBurnUp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
